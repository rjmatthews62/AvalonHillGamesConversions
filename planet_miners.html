<html>
<!-- Work in Progress conversion of Planet Miners to html/javascript, using async/await notation to simulate input/delays. -->

<head>
    <title>Planet Miners</title>
</head>
<script src="jquery-3.6.0.min.js"></script>
<script>
    //Utility
    var inputWait;

    function cls() { // Clear screeen.
        $("#console").html("");
    }

    function printArgs(args, usecr) {
        var s = "";
        for (let i = 0; i < args.length; i++) {
            if (i > 0) s += " ";
            s += args[i];
        }
        var content = $("#console").html();
        content += s;
        if (usecr) content += "</br>\n";
        $("#console").html(content);
    }

    function print() {
        printArgs(arguments, true);
    }

    function printNoCr() {
        printArgs(arguments, false);
    }

    function doInputWait() {
        var p = new Promise((myResolve, myReject) => {
            $("#enter").click(myResolve);
        }
        );
        return p;
    }

    async function input(prompt) {
        print(prompt);
        $("#enter").show();
        $("#input").show().val("").focus();
        await doInputWait();
        $("#enter").hide();
        $("#input").hide();
        return $("#input").val();
    }

    async function inputNum(prompt) {
        let result = await input(prompt);
        let n = parseInt(result, 10);
        if (isNaN(n)) n = 0;
        return n;
    }

    function dim(l1, l2) {
        var result = new Array();
        for (let i = 0; i <= l1; i++) result.push(new Array(l2 + 1));
        return result;
    }

    function RND() {
        return Math.random();
    }

    function INT(n) {
        return Math.floor(n);
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }


    const planets = [
        { name: "SUN", distance: 0, velocity: 0, resources: 0 },
        { name: "MERCURY", distance: 57.9, velocity: 7.1381306E-2, resources: 3 },
        { name: "VENUS", distance: 108.2, velocity: 2.7972187E-2, resources: 0 },
        { name: "EARTH", distance: 149.6, velocity: 1.7202895E-2, resources: 1 },
        { name: "MARS", distance: 227.9, velocity: 9.150476E-3, resources: 2 },
        { name: "CERES", distance: 413.6, velocity: 3.7373224E-3, resources: 2 },
        { name: "JUPITER", distance: 778, velocity: 1.4502525E-3, resources: 7 },
        { name: "SATURN", distance: 1427, velocity: 5.840002E-4, resources: 6 },
        { name: "URANUS", distance: 2870, velocity: 2.047598E-4, resources: 1 },
        { name: "NEPTUNE", distance: 4496, velocity: 1.043941E-4, resources: 1 },
        { name: "PLUTO", distance: 5910, velocity: 6.94505E-5, resources: 1 }
    ];

    const default_players = ["SIEGLER", "AICHI", "REGGIANE", "LYSANDER"];

    const NUM_PLANETS = 10;
    const NUM_SHIPS = 5;
    const NUM_PLAYERS = 4;
    const NUM_PATROLS = 12;
    const F1 = 10;
    var Q = new Array(NUM_PLANETS + 1);
    var T = new Array(NUM_PLANETS + 1);
    var resources = dim(NUM_PLANETS, NUM_PLAYERS)
    var planetAngle = new Array(NUM_PLANETS + 1);

    const MAX_PLAYER = NUM_PLAYERS - 1;
    const MAX_PATROLS = NUM_PATROLS - 1;
    const MAX_SHIP = NUM_SHIPS - 1;
    var S0 = dim(MAX_PLAYER, MAX_SHIP);
    var S1 = dim(MAX_PLAYER, MAX_SHIP);
    var S2 = dim(MAX_PLAYER, MAX_SHIP);
    var S3 = dim(MAX_PLAYER, MAX_SHIP);
    var S4 = new Array(MAX_PATROLS + 1);
    var S5 = new Array(MAX_PATROLS + 1);
    var S6 = new Array(MAX_PATROLS + 1);
    var M9 = 15;
    var M8 = 45;

    var SCREEN_ADDR = 15360;
    var CHARS_LINE = 64
    var S9 = 160;
    var S8 = 75;
    var D4 = 40
    var B1 = new Array(MAX_PLAYER + 1);
    var S = new Array(MAX_PLAYER + 1);
    var P = new Array(MAX_PLAYER + 1);
    var O = new Array(MAX_PLAYER + 1);
    var H = new Array(MAX_PLAYER + 1);
    var F; // Calculated patrol force.

    var D0, D3;

    //Game    
    async function initgame() {
        let resourceSeed;
        D0 = 1;
        D3 = D4 + INT(D4 * RND(0) / 4); // Length of game(?)
        for (let I = 0; I <= NUM_PLANETS; I++) {
            for (let J = 1; J <= NUM_PLAYERS; J++) {
                resources[I, J] = 0;
            }
            planetAngle[I] = 6.28 * RND(0);
            resourceSeed = planets[I].resources;
            resources[I, 0] = INT(resourceSeed * (RND(0) + RND(0) + RND(0) + RND(0)));
        }
        for (let I = 0; I < NUM_PLAYERS; I++) {
            for (let J = 0; J < NUM_SHIPS; J++) {
                S0[I, J] = 0;
                S3[I, J] = 0
                S1[I, J] = 3;
                S2[I, J] = 3;
            }
            for (let K = 1; K <= F1; K++) {
                let J = INT(RND(0) * NUM_SHIPS);
                S0[I, J] = S0 % [I, J] + 1;
            }
            resourceSeed = - 1;
            for (let J = 0; J < NUM_SHIPS; J++) {
                if (S0[I, J] >= resourceSeed) {
                    resourceSeed = S0[I, J]
                    H[I] = J;
                }
            }
            for (let i = 0; i < NUM_PLAYERS; i++) B1[i] = default_players[i];
            for (let J = 0; J < NUM_PATROLS; J++) {
                let P = 1 + INT(NUM_PLANETS * RND(0));
                S6[J] = 0;
                S4[J] = P;
                S5[J] = P;
            }
        }
        for (let K = 1; K <= NUM_PLAYERS; K++) {
            cls();
            print("READY TO INITIALIZE FAMILY", K);
            let A = "";
            A = await input("WILL A PERSON PLAY THIS FAMILY (Y/N)");
            if (A.toLowerCase().startsWith("y")) {
                print();
                print();
                B1[K - 1] = await input("YOUR FAMILY NAME");
                print();
                print();
                print("WELCOME TO THE YEAR 2050. YOU ARE THE LEADER OF THE");
                print("FABULOUSLY WEALTHY AND POLITICALLY POWERFUL " + B1[K - 1] + "S.");
                print();
                print("EARTH GOVERNMENT IS ABOUT TO OPEN THE SOLAR SYSTEM");
                print("FOR MINING CONCESSIONS. YOU WILL BE RACING AGAINST", NUM_PLAYERS - 1);
                print("OTHER FAMILIES, EACH HAVING", NUM_SHIPS, "SPACE SHIPS. EARTH WILL");
                print("BE MAINTAINING", NUM_PATROLS, "PATROL SPACE SHIPS, JUST TO KEEP");
                print("EVERYTHING FRIENDLY. GOOD LUCK!");
                print();
                await input("PRESS ENTER TO CONTINUE", A);
                S[K - 1] = 1;
            } else {
                S[K - 1] = 0;
            }
            O[K - 1] = K;
            P[K - 1] = 0;
        }

    }

    function calcPatrolForce(J) {
        F = 0;
        for (L = 0; L <= NUM_PATROLS - 1; L++) {
            if (S5[L] == J && S6[L] == 0) F = F + 1;
        }
        return F;
    }

    async function mainLoop() {
        cls();
        print("WORKING...");
        S = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            S = S + resources[P, 0];
        }
        if (S == 0 || (D0 > D3 && RND(0) > 0.9)) return; // Game over.
        T = 0;
        for (J = 1; J <= NUM_PLANETS; J++) {
            calcPatrolForce(J);
            T[J] = resources[J, 0] - 2 * F;
            for (K = 1; K <= NUM_PLAYERS; K++) {
                T[J] = T[J] + resources[J, K];
            }
            if (T[J] < 0) T[J] = 0;
            if (J == 3) T[J] = T[J] + 10;
            T = T + T[J];
        }
        Q[0] = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            Q[P] = Q[P - 1] + resources[P, 0] / S;
        }
        Q[0] = S;
        T[0] = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            T[P] = T[P - 1] + T[P] / T;
        }
        T[0] = T;
        for (J = 0; J <= NUM_PLAYERS - 1; J++) { // Randomize player order.
            K = INT(RND(0) * NUM_PLAYERS);
            S = O[J];
            O[J] = O[K];
            O[K] = S;
        }
        await delay(2000);
        for (A = 0; A <= NUM_PLAYERS - 1; A++) {
            P9 = O[A];
            if (S[P9 - 1] != 0) {  // Human player
                cls();
                print("COMMANDS FOR ", B1[P9 % - 1], " FOR DAY", D0, ":");
                await processCommands();
                //1070  GOSUB 1250: IF C% = 11 THEN 1090
                //1071  GOTO 1070
                //1080  GOSUB 3410
                //1090  NEXT 
            } else computerPlayer();
        }

    }

    async function processCommands() {
        let retry = true;
        for (; ;) {
            if (retry) {
                print("SELECT FROM THE FOLLOWING MENU:");
                print("1.  DISPLAY LARGE SOLAR SYSTEM");
                print("2.  DISPLAY SMALL SOLAR SYSTEM");
                print("3.  DISPLAY TRAVEL TIMES");
                print("4.  DISPLAY MINING INFORMATION");
                print("5.  DISPLAY SHIPS IN PLANETARY ORBITS");
                print("6.  DISPLAY STATUS OF YOUR SHIPS");
                print("7.  SET A SHIP DESTINATION");
                print("8.  PROTEST A CLAIM");
                print("9.  ATTEMPT TO CLAIM-JUMP");
                print("10. ATTEMPT SABOTAGE");
                print("11. FINISHED COMMANDS FOR TODAY");
            }
            C = await inputNum("YOUR COMMAND CHOICE");
            if (C < 1 || C > 11) retry = true;
            else {
                switch (C) {
                    case 1: await showMap(true); break;
                    case 2: await showMap(false); break;
                }
                //ON C% GOTO 1270,1280,1770,1870,1990,1290,2120,1300,1310,1320,1330
                if (C == 11) break;
                retry = false;
            }
        }
    }

    async function selectPlanet(startPlanet) {
        let P6 = startPlanet;
        do {
            print("SELECT FROM THE FOLLOWING PLANETS:");
            K = 0;
            for (P8 = P6; P8 <= NUM_PLANETS; P8++) {
                printNoCr("     ", P8, "-", planets[P8].name, " ");
                K = K + 1;
                if (K == 4) { K = 0; print(); }
            }
            if (K > 0) print();
            p8 = await inputNum("YOUR CHOICE");
        } while (!(P8 < P6 || P8 > NUM_PLANETS));
        return P8;
    }

    async function showMap(isLarge) {
        await selectPlanet(0);
        print("Showmap goes here.", isLarge);
    }

    function computerPlayer() {
        //TBA
    }
    async function game() {
        $("#enter").hide();
        $("#input").hide();
        $('#input').keypress(function (event) {
            if (event.keyCode == 13) {
                $('#enter').click();
            }
        });
        cls(); print(); print(); print("THE PLANET MINERS!");
        print("EXPANSION INTO THE SOLAR SYSTEM.");
        print();
        print("COPYRIGHT 1980 BY AVALON HILL MICROCOMPUTER GAMES");
        await delay(2000);
        await initgame();
        await mainLoop();

    }

    $(document).ready(game);

</script>

<body>
    <h1>Planet Miner</h1>
    <p id="console"></p>
    <input type="text" id="input" />
    <button type="button" id="enter">Enter</button>
</body>

</html>