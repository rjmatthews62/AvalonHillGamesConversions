<html>
<!-- Work in Progress conversion of Planet Miners to html/javascript, using async/await notation to simulate input/delays. -->
<head>
    <title>Planet Miners</title>
</head>
<script src="jquery-3.6.0.min.js"></script>
<script>
    //Utility
    var inputWait;

    function cls() { // Clear screeen.
        $("#console").html("");
    }

    function print() {
        var s = "";
        for (let i = 0; i < arguments.length; i++) {
            if (i > 0) s += " ";
            s += arguments[i];
        }
        var content = $("#console").html();
        content += s + "</br>\n";
        $("#console").html(content);
    }

    function doInputWait() {
        var p = new Promise((myResolve, myReject) => {
            $("#enter").click(myResolve);
        }
        );
        return p;
    }

    async function input(prompt) {
        print(prompt);
        $("#enter").show();
        $("#input").show();
        $("#input").val("");
        $("#input").focus();
        await doInputWait();
        $("#enter").hide();
        $("#input").hide();
        return $("#input").val();
    }

    function dim(l1, l2) {
        var result = new Array();
        for (let i = 0; i <= l1; i++) result.push(new Array(l2 + 1));
        return result;
    }

    function RND() {
        return Math.random();
    }

    function INT(n) {
        return Math.floor(n);
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }


    const planets = [
        { name: "SUN", distance: 0, velocity: 0, resources: 0 },
        { name: "MERCURY", distance: 57.9, velocity: 7.1381306E-2, resources: 3 },
        { name: "VENUS", distance: 108.2, velocity: 2.7972187E-2, resources: 0 },
        { name: "EARTH", distance: 149.6, velocity: 1.7202895E-2, resources: 1 },
        { name: "MARS", distance: 227.9, velocity: 9.150476E-3, resources: 2 },
        { name: "CERES", distance: 413.6, velocity: 3.7373224E-3, resources: 2 },
        { name: "JUPITER", distance: 778, velocity: 1.4502525E-3, resources: 7 },
        { name: "SATURN", distance: 1427, velocity: 5.840002E-4, resources: 6 },
        { name: "URANUS", distance: 2870, velocity: 2.047598E-4, resources: 1 },
        { name: "NEPTUNE", distance: 4496, velocity: 1.043941E-4, resources: 1 },
        { name: "PLUTO", distance: 5910, velocity: 6.94505E-5, resources: 1 }
    ];

    const default_players = ["SIEGLER", "AICHI", "REGGIANE", "LYSANDER"];

    const NUM_PLANETS = 10;
    const NUM_SHIPS = 5;
    const NUM_PLAYERS = 4;
    const NUM_PATROLS = 12;
    const F1 = 10;
    var Q = new Array(NUM_PLANETS + 1);
    var T = new Array(NUM_PLANETS + 1);
    var resources = dim(NUM_PLANETS, NUM_PLAYERS)
    var planetAngle = new Array(NUM_PLANETS + 1);

    const MAX_PLAYER = NUM_PLAYERS - 1;
    const MAX_PATROLS = NUM_PATROLS - 1;
    const MAX_SHIP = NUM_SHIPS - 1;
    var S0 = dim(MAX_PLAYER, MAX_SHIP);
    var S1 = dim(MAX_PLAYER, MAX_SHIP);
    var S2 = dim(MAX_PLAYER, MAX_SHIP);
    var S3 = dim(MAX_PLAYER, MAX_SHIP);
    var S4 = new Array(MAX_PATROLS + 1);
    var S5 = new Array(MAX_PATROLS + 1);
    var S6 = new Array(MAX_PATROLS + 1);
    var M9 = 15;
    var M8 = 45;

    var SCREEN_ADDR = 15360;
    var CHARS_LINE = 64
    var S9 = 160;
    var S8 = 75;
    var D4 = 40
    var B1 = new Array(MAX_PLAYER + 1);
    var S = new Array(MAX_PLAYER + 1);
    var P = new Array(MAX_PLAYER + 1);
    var O = new Array(MAX_PLAYER + 1);
    var H = new Array(MAX_PLAYER + 1);

    var D0, D3;

    //Game    
    async function initgame() {
        let resourceSeed;
        D0 = 1;
        D3 = D4 + INT(D4 * RND(0) / 4); // Length of game(?)
        for (let I = 0; I <= NUM_PLANETS; I++) {
            for (let J = 1; J <= NUM_PLAYERS; J++) {
                resources[I, J] = 0;
            }
            planetAngle[I] = 6.28 * RND(0);
            resourceSeed = planets[I].resources;
            resources[I, 0] = INT(resourceSeed * (RND(0) + RND(0) + RND(0) + RND(0)));
        }
        for (let I = 0; I < NUM_PLAYERS; I++) {
            for (let J = 0; J < NUM_SHIPS; J++) {
                S0[I, J] = 0;
                S3[I, J] = 0
                S1[I, J] = 3;
                S2[I, J] = 3;
            }
            for (let K = 1; K <= F1; K++) {
                let J = INT(RND(0) * NUM_SHIPS);
                S0[I, J] = S0 % [I, J] + 1;
            }
            resourceSeed = - 1;
            for (let J = 0; J < NUM_SHIPS; J++) {
                if (S0[I, J] >= resourceSeed) {
                    resourceSeed = S0[I, J]
                    H[I] = J;
                }
            }
            for (let i = 0; i < NUM_PLAYERS; i++) B1[i] = default_players[i];
            for (let J = 0; J < NUM_PATROLS; J++) {
                let P = 1 + INT(NUM_PLANETS * RND(0));
                S6[J] = 0;
                S4[J] = P;
                S5[J] = P;
            }
        }
        for (let K = 1; K <= NUM_PLAYERS; K++) {
            cls();
            print("READY TO INITIALIZE FAMILY", K);
            let A = "";
            A = await input("WILL A PERSON PLAY THIS FAMILY (Y/N)");
            if (A.toLowerCase().startsWith("y")) {
                print();
                print();
                B1[K - 1] = await input("YOUR FAMILY NAME");
                print();
                print();
                print("WELCOME TO THE YEAR 2050. YOU ARE THE LEADER OF THE");
                print("FABULOUSLY WEALTHY AND POLITICALLY POWERFUL " + B1[K - 1] + "S.");
                print();
                print("EARTH GOVERNMENT IS ABOUT TO OPEN THE SOLAR SYSTEM");
                print("FOR MINING CONCESSIONS. YOU WILL BE RACING AGAINST", NUM_PLAYERS - 1);
                print("OTHER FAMILIES, EACH HAVING", NUM_SHIPS, "SPACE SHIPS. EARTH WILL");
                print("BE MAINTAINING", NUM_PATROLS, "PATROL SPACE SHIPS, JUST TO KEEP");
                print("EVERYTHING FRIENDLY. GOOD LUCK!");
                print();
                await input("PRESS ENTER TO CONTINUE", A);
                S[K - 1] = 1;
            } else {
                S[K - 1] = 0;
            }
            O[K - 1] = K;
            P[K - 1] = 0;
        }

    }

    async function game() {
        $("#enter").hide();
        $("#input").hide();
        $('#input').keypress(function (event) {
            if (event.keyCode == 13) {
                $('#enter').click();
            }
        });
        cls(); print(); print(); print("THE PLANET MINERS!");
        print("EXPANSION INTO THE SOLAR SYSTEM.");
        print();
        print("COPYRIGHT 1980 BY AVALON HILL MICROCOMPUTER GAMES");
        await delay(2000);
        await initgame();
        print("READY");

    }

    $(document).ready(game);

</script>

<body>
    <h1>Planet Miner</h1>
    <p id="console"></p>
    <input type="text" id="input" />
    <button type="button" id="enter">Enter</button>
</body>

</html>
