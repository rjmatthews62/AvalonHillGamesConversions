<html>
<!-- Work in Progress conversion of Planet Miners to html/javascript, using async/await notation to simulate input/delays. -->

<head>
    <title>Planet Miners</title>
</head>
<script src="jquery-3.6.0.min.js"></script>
<script>
    //Utility
    var screenMem = new Array(0x400); // Simulated screen memory.
    var linePos = 0; // Estimated cursor position for TAB

    function cls() { // Clear screeen.
        $("#console").html("");
        screenMem.fill(32); // Spaces.
    }


    function calcLinePos(s) {
        var ix = s.lastIndexOf("\n");
        if (ix < 0) ix = 0;
        return s.length - ix;
    }

    function printArgs(args, usecr = true, space = true) {
        var s = "";
        for (let i = 0; i < args.length; i++) {
            if (i > 0 && space) s += " ";
            s += args[i];
        }
        var content = $("#console").html();
        if (linePos > 0) {
            let x = calcLinePos(content);
            while (x++ < linePos) content += " ";
        }
        content += s;
        linePos += s.length % CHARS_LINE;
        if (usecr) {
            content += "\n";
            linePos = 0;
        }
        $("#console").html(content);
    }

    function print() {
        printArgs(arguments, true);
    }

    function printNoCr() {
        printArgs(arguments, false);
    }

    function printPlain() {
        printArgs(arguments, false, false);
    }

    function doInputWait() {
        var p = new Promise((myResolve, myReject) => {
            $("#enter").click(myResolve);
        }
        );
        return p;
    }

    function updateScreen() {
        for (let y = 0; y < 16; y++) {
            let s = "";
            let p = y * CHARS_LINE;
            for (let x = 0; x < CHARS_LINE; x++) {
                s += String.fromCharCode(screenMem[x + p]);
            }
            print(s);
        }
    }

    async function input(prompt) {
        print(prompt);
        $("#enter").show();
        $("#input").show().val("").focus();
        await doInputWait();
        $("#enter").hide();
        $("#input").hide();
        return $("#input").val();
    }

    async function inputNum(prompt) {
        let result = await input(prompt);
        let n = parseInt(result, 10);
        if (isNaN(n)) n = 0;
        return n;
    }

    function dim(l1, l2) {
        var result = new Array();
        for (let i = 0; i <= l1; i++) result.push(new Array(l2 + 1));
        return result;
    }

    function RND() {
        return Math.random();
    }

    function INT(n) {
        return Math.floor(n);
    }

    function SIN(n) {
        return Math.sin(n);
    }

    function COS(n) {
        return Math.cos(n);
    }

    function ABS(n) {
        return Math.abs(n);
    }

    function SQR(n) {
        return Math.sqrt(n);
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function PEEK(addr) {
        if (addr < SCREEN_ADDR || addr >= SCREEN_ADDR + SCREEN_SIZE) return 0;
        return screenMem[addr - SCREEN_ADDR];
    }

    function POKE(addr, val) {
        if (addr < SCREEN_ADDR || addr >= SCREEN_ADDR + SCREEN_SIZE) return 0;
        screenMem[addr - SCREEN_ADDR] = (val & 0xff);
    }

    function ASC(c) {
        if (c == "") c = " ";
        return c.charCodeAt(0);
    }

    function LEN(s) {
        return s.length;
    }

    function MID(s, i, len) {
        return s.substr(i - 1, len);
    }

    function LEFT(s, len) {
        return s.substr(0, len);
    }

    function TAB(n) {
        var result = "";
        while (linePos < (n - 1)) {
            //result += " ";
            linePos += 1;
        }
        return result;
    }

    var CLS = cls, PRINT = print;


    const planets = [
        { name: "SUN", distance: 0, velocity: 0, resources: 0 },
        { name: "MERCURY", distance: 57.9, velocity: 7.1381306E-2, resources: 3 },
        { name: "VENUS", distance: 108.2, velocity: 2.7972187E-2, resources: 0 },
        { name: "EARTH", distance: 149.6, velocity: 1.7202895E-2, resources: 1 },
        { name: "MARS", distance: 227.9, velocity: 9.150476E-3, resources: 2 },
        { name: "CERES", distance: 413.6, velocity: 3.7373224E-3, resources: 2 },
        { name: "JUPITER", distance: 778, velocity: 1.4502525E-3, resources: 7 },
        { name: "SATURN", distance: 1427, velocity: 5.840002E-4, resources: 6 },
        { name: "URANUS", distance: 2870, velocity: 2.047598E-4, resources: 1 },
        { name: "NEPTUNE", distance: 4496, velocity: 1.043941E-4, resources: 1 },
        { name: "PLUTO", distance: 5910, velocity: 6.94505E-5, resources: 1 }
    ];

    const default_players = ["SIEGLER", "AICHI", "REGGIANE", "LYSANDER"];

    const NUM_PLANETS = 10;
    const NUM_SHIPS = 5;
    const NUM_PLAYERS = 4;
    const NUM_PATROLS = 12;
    const F1 = 10;
    var Q = new Array(NUM_PLANETS + 1);
    var T = new Array(NUM_PLANETS + 1);
    var resources = dim(NUM_PLANETS, NUM_PLAYERS)
    var planetAngle = new Array(NUM_PLANETS + 1);

    const MAX_PLAYER = NUM_PLAYERS - 1;
    const MAX_PATROLS = NUM_PATROLS - 1;
    const MAX_SHIP = NUM_SHIPS - 1;
    var S0 = dim(MAX_PLAYER, MAX_SHIP);
    var S1 = dim(MAX_PLAYER, MAX_SHIP);
    var S2 = dim(MAX_PLAYER, MAX_SHIP);
    var S3 = dim(MAX_PLAYER, MAX_SHIP);
    var S4 = new Array(MAX_PATROLS + 1);
    var S5 = new Array(MAX_PATROLS + 1);
    var S6 = new Array(MAX_PATROLS + 1);
    var M9 = 15;
    var M8 = 45;

    const SCREEN_ADDR = 15360;
    const SCREEN_SIZE = 0x400;
    const CHARS_LINE = 64
    var S9 = 160;
    var S8 = 75;
    var D4 = 40
    var B1 = new Array(MAX_PLAYER + 1);
    var S = new Array(MAX_PLAYER + 1);
    var P = new Array(MAX_PLAYER + 1);
    var O = new Array(MAX_PLAYER + 1);
    var H = new Array(MAX_PLAYER + 1);
    var F; // Calculated patrol force.

    var D0, D3;

    //Game    
    async function initgame() {
        let resourceSeed;
        D0 = 1;
        D3 = D4 + INT(D4 * RND(0) / 4); // Length of game(?)
        for (let I = 0; I <= NUM_PLANETS; I++) {
            for (let J = 1; J <= NUM_PLAYERS; J++) {
                resources[I][J] = 0;
            }
            planetAngle[I] = 6.28 * RND(0);
            resourceSeed = planets[I].resources;
            resources[I][0] = INT(resourceSeed * (RND(0) + RND(0) + RND(0) + RND(0)));
        }
        for (let I = 0; I < NUM_PLAYERS; I++) {
            for (let J = 0; J < NUM_SHIPS; J++) {
                S0[I][J] = 0;
                S3[I][J] = 0
                S1[I][J] = 3;
                S2[I][J] = 3;
            }
            for (let K = 1; K <= F1; K++) {
                let J = INT(RND(0) * NUM_SHIPS);
                S0[I][J] = S0[I][J] + 1;
            }
            resourceSeed = - 1;
            for (let J = 0; J < NUM_SHIPS; J++) {
                if (S0[I][J] >= resourceSeed) {
                    resourceSeed = S0[I][J]
                    H[I] = J;
                }
            }
            for (let i = 0; i < NUM_PLAYERS; i++) B1[i] = default_players[i];
            for (let J = 0; J < NUM_PATROLS; J++) {
                let P = 1 + INT(NUM_PLANETS * RND(0));
                S6[J] = 0;
                S4[J] = P;
                S5[J] = P;
            }
        }
        for (let K = 1; K <= NUM_PLAYERS; K++) {
            cls();
            print("READY TO INITIALIZE FAMILY", K);
            let A = "";
            A = await input("WILL A PERSON PLAY THIS FAMILY (Y/N)");
            if (A.toLowerCase().startsWith("y")) {
                print();
                print();
                B1[K - 1] = await input("YOUR FAMILY NAME");
                print();
                print();
                print("WELCOME TO THE YEAR 2050. YOU ARE THE LEADER OF THE");
                print("FABULOUSLY WEALTHY AND POLITICALLY POWERFUL " + B1[K - 1] + "S.");
                print();
                print("EARTH GOVERNMENT IS ABOUT TO OPEN THE SOLAR SYSTEM");
                print("FOR MINING CONCESSIONS. YOU WILL BE RACING AGAINST", NUM_PLAYERS - 1);
                print("OTHER FAMILIES, EACH HAVING", NUM_SHIPS, "SPACE SHIPS. EARTH WILL");
                print("BE MAINTAINING", NUM_PATROLS, "PATROL SPACE SHIPS, JUST TO KEEP");
                print("EVERYTHING FRIENDLY. GOOD LUCK!");
                print();
                await input("PRESS ENTER TO CONTINUE", A);
                S[K - 1] = 1;
            } else {
                S[K - 1] = 0;
            }
            O[K - 1] = K;
            P[K - 1] = 0;
        }

    }

    function calcPatrolForce(J) {
        F = 0;
        for (L = 0; L <= NUM_PATROLS - 1; L++) {
            if (S5[L] == J && S6[L] == 0) F = F + 1;
        }
        return F;
    }

    function calcShipForce(planet, family) {
        // line 2300 
        let J = planet;
        let K = family;
        F = 0;
        for (let L = 0; L < NUM_SHIPS; L++) {
            if ((S1[K - 1][L] == -J) || (S2[K - 1][L] == J && S3[K - 1][L] == 0)) F = F + 1;
        }
        return (F);
    }
    function calcTravelTime(planet1, planet2) {
        //4470 rem Travel time calc From J to P8, result returned in S
        let J = planet1; P8 = planet2;
        S = SQR(planets[J].distance * planets[J].distance + planets[P8].distance * planets[P8].distance - 2 *
            planets[P8].distance * planets[J].distance * COS(planetAngle[J] - planetAngle[P8]));
        S = -  INT(-  SQR(S) * 0.23383161);
        return S;
    }

    async function mainLoop() {
        cls();
        print("WORKING...");
        S = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            S = S + resources[P][0];
        }
        if (S == 0 || (D0 > D3 && RND(0) > 0.9)) return; // Game over.
        T = 0;
        for (J = 1; J <= NUM_PLANETS; J++) {
            calcPatrolForce(J);
            T[J] = resources[J][0] - 2 * F;
            for (K = 1; K <= NUM_PLAYERS; K++) {
                T[J] = T[J] + resources[J][K];
            }
            if (T[J] < 0) T[J] = 0;
            if (J == 3) T[J] = T[J] + 10;
            T = T + T[J];
        }
        Q[0] = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            Q[P] = Q[P - 1] + resources[P][0] / S;
        }
        Q[0] = S;
        T[0] = 0;
        for (P = 1; P <= NUM_PLANETS; P++) {
            T[P] = T[P - 1] + T[P] / T;
        }
        T[0] = T;
        for (J = 0; J <= NUM_PLAYERS - 1; J++) { // Randomize player order.
            K = INT(RND(0) * NUM_PLAYERS);
            S = O[J];
            O[J] = O[K];
            O[K] = S;
        }
        await delay(1000);
        for (A = 0; A <= NUM_PLAYERS - 1; A++) {
            P9 = O[A];
            if (S[P9 - 1] != 0) {  // Human player
                cls();
                print("COMMANDS FOR ", B1[P9 - 1], " FOR DAY", D0, ":");
                await processCommands(P9);
                //1070  GOSUB 1250: IF C% = 11 THEN 1090
                //1071  GOTO 1070
                //1080  GOSUB 3410
                //1090  NEXT 
            } else computerPlayer();
        }

    }

    async function processCommands(player) {
        let retry = true;
        for (; ;) {
            if (retry) {
                print("SELECT FROM THE FOLLOWING MENU:");
                print("1.  DISPLAY LARGE SOLAR SYSTEM");
                print("2.  DISPLAY SMALL SOLAR SYSTEM");
                print("3.  DISPLAY TRAVEL TIMES");
                print("4.  DISPLAY MINING INFORMATION");
                print("5.  DISPLAY SHIPS IN PLANETARY ORBITS");
                print("6.  DISPLAY STATUS OF YOUR SHIPS");
                print("7.  SET A SHIP DESTINATION");
                print("8.  PROTEST A CLAIM");
                print("9.  ATTEMPT TO CLAIM-JUMP");
                print("10. ATTEMPT SABOTAGE");
                print("11. FINISHED COMMANDS FOR TODAY");
            }
            C = await inputNum("YOUR COMMAND CHOICE");
            if (C < 1 || C > 11) retry = true;
            else {
                switch (C) {
                    case 1: await showMap(true); break;
                    case 2: await showMap(false); break;
                    case 3: travelTimes(); break;
                    case 4: showMining(); break;
                    case 5: showShipsInOrbit(); break;
                    case 6: showShipStatus(player); break;
                    case 7: await setShipDest(player); break;
                }
                //ON C% GOTO 1270,1280,1770,1870,1990,1290,2120,1300,1310,1320,1330
                if (C == 11) break;
                retry = false;
            }
        }
    }

    async function selectPlanet(startPlanet, prompt = "SELECT FROM THE FOLLOWING PLANETS:") {
        let P6 = startPlanet;
        do {
            print();
            K = 0;
            for (P8 = P6; P8 <= NUM_PLANETS; P8++) {
                printPlain(TAB(K * 10 + 1));
                printPlain(P8, "-", planets[P8].name, " ");
                K = K + 1;
                if (K == 4) { K = 0; print(); }
            }
            if (K > 0) print();
            P8 = await inputNum("YOUR CHOICE");
        } while (P8 < P6 || P8 > NUM_PLANETS);
        return P8;
    }

    function showMining() {
        print();
        print("MINING CONCESSIONS AS OF DAY", D0);
        printPlain("PLANET");
        for (J = 0; J <= MAX_PLAYER; J++) {
            printPlain(TAB(10 + 11 * J), LEFT(B1[J], 9));
        };
        printPlain(TAB(10 + 11 * NUM_PLAYERS), "UNCLAIMED");
        print();
        printPlain("------");
        for (J = 0; J <= NUM_PLAYERS; J++) {
            printPlain(TAB(10 + 11 * J), "=========");
        };
        print();
        for (P = 1; P <= NUM_PLANETS; P++) {
            printPlain(planets[P].name);
            for (J = 1; J <= NUM_PLAYERS; J++) {
                printPlain(TAB(12 + 11 * (J - 1)), resources[P][J]);
            }
            printPlain(TAB(12 + 11 * NUM_PLAYERS), resources[P][0]);
            print();
        }
    }

    async function showMap(isLarge) {
        J = await selectPlanet(0);
        CLS();
        if (isLarge) S7 = S9; else S7 = S8;
        if (S7 == S8) print("SMALL"); else print("LARGE");
        print("SOLAR SYSTEM CENTERED ON ", planets[J].name);
        X1 = planets[J].distance * COS(planetAngle[J]);
        Y1 = planets[J].distance * SIN(planetAngle[J]);
        for (K = 0; K <= NUM_PLANETS; K++) {
            X2 = planets[K].distance * COS(planetAngle[K]) - X1;
            Y2 = planets[K].distance * SIN(planetAngle[K]) - Y1;
            if (J != K) {
                X3 = SQR(SQR(X2 * X2 + Y2 * Y2)); X2 = X2 / X3; Y2 = Y2 / X3;
            }
            V = INT((-Y2 + .5 * S7) * M9 / S7) + 1;
            H = INT((X2 + .5 * S7) * M8 / S7) + 1;
            if (V < 1 || V > M9 || H < 1 || H > M8) continue;
            P = (V - 1) * CHARS_LINE + SCREEN_ADDR + H;
            P2 = PEEK(P); // Simulating TRS-80 screen map.
            if (P2 != 32) continue; // If not blank, bail.
            if (K == 0) P2 = ASC("*"); else P2 = ASC("+");
            POKE(P, P2);
            for (P2 = 1; P2 <= 7; P2++) {

                H = H + 1; P = P + 1; if (H > M8 + 7) break;
                let tmp = PEEK(P);
                if (tmp != 43 && tmp != 42) {
                    if (P2 > LEN(planets[K].name)) POKE(P, 32); else POKE(P, ASC(MID(planets[K].name, P2, 1)));
                } else break;
            }
        }
        updateScreen();
        await input("PRESS ENTER");
    }

    function showShipsInOrbit() {
        print();
        print("SHIPS IN PLANETARY ORBIT ON DAY", D0);
        printPlain("PLANET");
        for (J = 0; J <= NUM_PLAYERS - 1; J++) {
            printPlain(TAB(10 + 11 * J), LEFT(B1[J], 9));
        }
        printPlain(TAB(10 + 11 * NUM_PLAYERS), "PATROL");
        print();
        printPlain("------");
        for (J = 0; J <= NUM_PLAYERS; J++) {
            printPlain(TAB(10 + 11 * J), "=========");
        }
        print()
        for (J = 1; J <= NUM_PLANETS; J++) {
            printPlain(planets[J].name);
            for (K = 1; K <= NUM_PLAYERS; K++) {
                printPlain(TAB(12 + 11 * (K - 1)));
                calcShipForce(J, K);
                printPlain(F);
            }
            printPlain(TAB(12 + 11 * NUM_PLAYERS));
            calcPatrolForce(J);
            print(F);
        }
        print()
    }

    function showShipStatus(player) {
        // line 1470
        J = player;
        print();
        printPlain("SHIP STATUS OF ", B1[J - 1], " FAMILY ON DAY", D0); print();
        printPlain("SHIP (SKILL)");
        printPlain(TAB(15), "FROM");
        printPlain(TAB(23), "TO");
        printPlain(TAB(31), "DAYS TO GO");
        print();
        printPlain("------------");
        printPlain(TAB(15), "----");
        printPlain(TAB(23), "--");
        printPlain(TAB(31), "----------");
        print();
        for (I = 0; I <= NUM_SHIPS - 1; I++) {
            if (S0[J - 1][I] < 0) continue;
            printPlain(I + 1, TAB(6), "(", S0[J - 1][I], ")");
            printPlain(TAB(15));
            P8 = ABS(S1[J - 1][I]);
            printPlain(planets[P8].name);
            printPlain(TAB(23), planets[S2[J - 1][I]].name);
            printPlain(TAB(31), S3[J - 1][I]);
            print();
        }
    }

    function travelTimes() {
        print()
        print("SOLAR SYSTEM TRAVEL TIMES (DAYS)")
        print("FROM/TO");
        for (J = 1; J <= NUM_PLANETS; J++) {
            printPlain(TAB(8 + 4 * J));
            printPlain(J);
        };
        print()
        print("---------");
        for (J = 1; J <= NUM_PLANETS; J++) {
            printPlain(TAB(8 + 4 * J));
            printPlain("===");
        };
        print();
        for (J = 1; J <= NUM_PLANETS; J++) {
            printPlain(J, " ", planets[J].name);
            for (P8 = 1; P8 <= NUM_PLANETS; P8++) {
                let ttime = calcTravelTime(J, P8);
                printPlain(TAB(8 + 4 * P8));
                printPlain(ttime);
            };
            print();
        };
        print();
    }

    async function setShipDest(player) {
        P9 = player;
        showShipStatus(player);
        do {
            P7 = await inputNum("SHIP NUMBER");
        } while (P7 < 1 || P7 > NUM_SHIPS);
        if ((S3[P9 - 1][P7 - 1] = 0 || S1[P9 - 1][P7 - 1] < 0)) {
            print("NOT ALLOWED ON THAT SHIP.");
            return;
        }
        P6 = 1;
        P8 = await selectPlanet(P6, "DESTINATION:");
        J = ABS(S1[P9 - 1][P7 - 1]);
        S = calcTravelTime(J, P8);
        S3[P9 - 1][P7 - 1] = S;  // Travel times
        S1[P9 - 1][P7 - 1] = - J; // From
        S2[P9 - 1][P7 - 1] = P8; // To
        showShipStatus(player);
    }

    function computerPlayer() {
        //TBA
    }
    async function game() {
        $("#enter").hide();
        $("#input").hide();
        $('#input').keypress(function (event) {
            if (event.keyCode == 13) {
                $('#enter').click();
            }
        });
        cls(); print(); print(); print("THE PLANET MINERS!");
        print("EXPANSION INTO THE SOLAR SYSTEM.");
        print();
        print("COPYRIGHT 1980 BY AVALON HILL MICROCOMPUTER GAMES");
        await delay(1000);
        await initgame();
        await mainLoop();

    }

    $(document).ready(game);

</script>

<body>
    <h1>Planet Miner</h1>
    <pre id="console"></pre>
    <input type="text" id="input" />
    <button type="button" id="enter">Enter</button>
</body>

</html>